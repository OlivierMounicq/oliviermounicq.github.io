<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<div class="mainDiv">



<h1>Entity Framework and LINQ to Entities (4) Query Methods</h1>

<p>This part discusses how to query SQL database with the defined mapping classes. Entity Framework and LINQ to Entities supports most of the extension methods provided by Queryable class:</p>
<ol><!--StartFragment-->
<li>Return a new IQueryable&lt;T&gt; source:</li>
<ul>
<li>Generation: DefaultIfEmpty</li>
<li>Filtering (restriction): <span style="text-decoration: underline;">Where</span>, OfType</li>
<li>Mapping (projection): <span style="text-decoration: underline;">Select</span></li>
<li>Grouping: <span style="text-decoration: underline;">GroupBy </span></li>
<li>Join: <span style="text-decoration: underline;">Join</span>, <span style="text-decoration: underline;">GroupJoin</span>, <span style="text-decoration: underline;">SelectMany</span>, <span style="text-decoration: underline;">Select</span></li>
<li>Apply: <span style="text-decoration: underline;">GroupBy</span>, <span style="text-decoration: underline;">GroupJoin</span>, <span style="text-decoration: underline;">Select</span></li>
<li>Concatenation: Concat</li>
<li>Set: <span style="text-decoration: underline;">Distinct</span>, <span style="text-decoration: underline;">GroupBy</span>, <span style="text-decoration: underline;">Union</span>, <span style="text-decoration: underline;">Intersect</span>, <span style="text-decoration: underline;">Except </span></li>
<li>Convolution: <span style="text-decoration: line-through;">Zip </span></li>
<li>Partitioning: Take, Skip, <span style="text-decoration: line-through;">TakeWhile</span>, <span style="text-decoration: line-through;">SkipWhile</span></li>
<li>Ordering: <span style="text-decoration: underline;">OrderBy</span>, <span style="text-decoration: underline;">ThenBy</span>, <span style="text-decoration: underline;">OrderByDescending</span>, <span style="text-decoration: underline;"> ThenByDescending</span>, <span style="text-decoration: line-through;">Reverse </span></li>
<li>Conversion: Cast, AsQueryable</li>
</ul>
<li>Return a single value:
<ul>
<li>Element: First, FirstOrDefault, <span style="text-decoration: line-through;">Last</span>, <span style="text-decoration: line-through;">LastOrDefault</span>, <span style="text-decoration: line-through;">ElementAt</span>, <span style="text-decoration: line-through;"> ElementAtOrDefault</span>, Single, SingleOrDefault</li>
<li>Aggregation: <span style="text-decoration: line-through;">Aggregate</span>, Count, LongCount, Min, Max, Sum, Average</li>
<li>Quantifier: All, Any, <span style="text-decoration: underline;">Contains</span></li>
<li>Equality: <span style="text-decoration: line-through;">SequenceEqual</span></li>
</ul>
</li>
</ol>
<p>If a Queryable method has no proper target SQL translation, this method is not supported by LINQ to Entities. Query with such a methods will result NotSupportedException. In above list:</p>
<ul>
<li>The crossed methods are not supported (<a href="https://msdn.microsoft.com/en-us/library/bb738550.aspx" target="_blank">the list in MDSN</a> is not up to date), because there is no general translation to SQL, e.g. SQL database has no built-in Zip operation, etc..</li>
<li>The underlined methods have some overloads not supported:</li>
<ul>
<li>For GroupBy, Join, GroupJoin, Distinct, Union, Intersect, Except, Contains, the overloads with IEqualityComparer&lt;T&gt; parameter are not supported, because apparently IEqualityComparer&lt;T&gt; has no equivalent SQL translation</li>
<li>For OrderBy, ThenBy, OrderByDescending, ThenByDescending, the overloads with IComparer&lt;T&gt; parameter are not supported</li>
<li>For Where, Select, SelectMany, the indexed overloads are not supported</li>
</ul>
</ul>
<p>In this part, all the LINQ to Entities queries will be demonstrated with query methods. All kinds of LINQ queries share the same query expression pattern, which has been discussed in detail in the LINQ to Objects chapter. Here query expressions will only be demonstrated for join queries, where they may be more intuitive than query methods.</p>
<p>Here, to make the code shorter, one database object will be reused for all the queries:</p>
<pre class="code"><span style="color: blue;">internal static partial class </span><span style="color: #2b91af;">QueryMethods
</span><span style="color: black;">{
    </span><span style="color: blue;">private static readonly </span><span style="color: #2b91af;">AdventureWorks </span><span style="color: black;">AdventureWorks = </span><span style="color: blue;">new </span><span style="color: #2b91af;">AdventureWorks</span><span style="color: black;">();
}</span></pre>
<p>In reality, a DbContext object should always be constructed and disposed for each <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html" target="_blank">unit of work</a>.</p>
<h1>Return a new IQueryable&lt;T&gt; source</h1>
<p>Just like all the other kinds of LINQ, LINQ to Entities implements deferred execution for these query methods. The SQL query is translated and executed only when the values are pulled from IQueryable&lt;T&gt;.</p>
<h2>Generation</h2>
<p>As fore mentioned, <span style="color: blue;"></span><span style="color: black;">DefaultIfEmpty is the only generation method provided:</span></p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DefaultIfEmpty()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source.DefaultIfEmpty(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: black;">category?.Name</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>When ForEach is called, the query is translated to SQL and executed:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM   </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]
    </span><span style="color: gray;">LEFT OUTER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: blue;">ON </span><span style="color: black;">1 </span><span style="color: gray;">= </span><span style="color: black;">1</span></pre>
<p>The OUTER JOIN ON 1 = 1 from a single row table guarantees that the SQL query result has at least 1 row. If the right table of JOIN has rows, the JOIN results is the rows; otherwise, the JOIN result will be 1 row, where each column is NULL.</p>
<p><span style="color: black;">The other <span style="color: blue;"></span><span style="color: black;">DefaultIfEmpty </span>overload accepts a specified default value:</span></p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DefaultIfEmptyWithPrimitive()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">int</span><span style="color: black;">&gt; categories = source
        .Select(category =&gt; category.ProductCategoryID)
        .DefaultIfEmpty(-1); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The translation checks if the JOIN result is NULL. If so, the specified default value –1 is used:</p>
<pre class="code"><span style="color: blue;">SELECT
    CASE WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: gray;">IS NULL) </span><span style="color: blue;">THEN </span><span style="color: gray;">-</span><span style="color: black;">1 </span><span style="color: blue;">ELSE </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM   </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]
    </span><span style="color: gray;">LEFT OUTER JOIN  (</span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
        </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as tinyint</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Project1] </span><span style="color: blue;">ON </span><span style="color: black;">1 </span><span style="color: gray;">= </span><span style="color: black;">1</span></pre>
<p>This overload and its translation works for a single column. It throws NotSupportedException for entity type:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DefaultIfEmptyWithEntity()
{
    </span><span style="color: #2b91af;">ProductCategory </span><span style="color: black;">defaultCategory = </span><span style="color: blue;">new </span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">();
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source.DefaultIfEmpty(defaultCategory); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category?.Name)); </span><span style="color: green;">// Execute query.
    // NotSupportedException: Unable to create a constant value of type 'Dixin.Linq.EntityFramework.ProductCategory'. Only primitive types or enumeration types are supported in this context.
</span><span style="color: black;">}</span></pre>
<p><span style="color: black;">DefaultIfEmpty can also be used to implement outer join, which will be discussed soon.</span></p>
<h2>Filtering (restriction)</h2>
<p>Entity Framework translates Queryable.Where to SQL WHERE clause. And the predicate expression tree (again, not predicate function in Enumerable.Where) is translated to the condition in WHERE clause</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Where()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source.Where(category =&gt; category.ProductCategoryID &gt; 0); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: black;">category.Name</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">&gt; </span><span style="color: black;">0</span></pre>
<p>The C# || operator in the predicate expression tree is translated to SQL OR operator in WHERE clause:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">WhereWithOr()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source.Where(category =&gt;
        category.ProductCategoryID &lt;= 1 || category.ProductCategoryID &gt;= 4); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}
</span></pre>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">WHERE </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">&lt;= </span><span style="color: black;">1</span><span style="color: gray;">) OR (</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">&gt;= </span><span style="color: black;">4</span><span style="color: gray;">)</span><span style="color: green;">
</span></pre>
<p>The C# &amp;&amp; operator is translated to SQL AND operator. Also, multiple Where calls are translated to one single WHERE clause with AND too</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">WhereWithAnd()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source.Where(category =&gt;
        category.ProductCategoryID &gt; 0 &amp;&amp; category.ProductCategoryID &lt; 5); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">WhereAndWhere()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; categories = source
        .Where(category =&gt; category.ProductCategoryID &gt; 0)
        .Where(category =&gt; category.ProductCategoryID &lt; 5); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>These 2 LINQ to Entities queries are translated to identical SQL queries:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">WHERE </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">&gt; </span><span style="color: black;">0</span><span style="color: gray;">) AND (</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">&lt; </span><span style="color: black;">5</span><span style="color: gray;">)</span></pre>
<p>The other filtering method, OfType, is equivalent to Where with is operator:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">WhereWithIs()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; products = source.Where(product =&gt; product </span><span style="color: blue;">is </span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.GetType().Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
    // NotSupportedException: Method 'Boolean IsNullOrEmpty(System.String)' has no supported translation to SQL.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">OfTypeWithEntity()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">&gt; products = source.OfType&lt;</span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">&gt;(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.GetType().Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The Where and OfType queries are both translated to WHERE:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: red;">'0X0X' </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[RowVersion] </span><span style="color: blue;">AS </span><span style="color: black;">[RowVersion]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Style] </span><span style="color: gray;">= </span><span style="color: red;">N'U'</span></pre>
<p>OfType works for entity type. It throws NotSupportedException for primitive type representing a single column:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OfTypeWithPrimitive()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">int</span><span style="color: black;">&gt; products = source.Select(p =&gt; p.ProductID).OfType&lt;</span><span style="color: blue;">int</span><span style="color: black;">&gt;(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
    // NotSupportedException: 'System.Int32' is not a valid metadata type for type filtering operations. Type filtering is only valid on entity types and complex types.
</span><span style="color: black;">}</span></pre>
<h2>Mapping (projection)</h2>
<p>In above queries, Queryable.Select is not called, so the translated SELECT clause contains all the mapped columns to construct the entity objects; if Select is called, the selector expression tree is translated to specified columns in SELECT clause. For example:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Select()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; categories = source.Select(category =&gt;
        category.Name + category.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">SelectWithStringConcat()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; categories = source.Select(category =&gt;
        </span><span style="color: blue;">string</span><span style="color: black;">.Concat(category.Name, category.Name)); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(category)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>These 2 queries are semantically equivalent. The C# + operator and string.Concat method are both translated to SQL + operator:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: gray;">+ </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]</span></pre>
<p>Select supports Anonymous type:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SelectAnonymousType()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source.Select(product =&gt;
        </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, IsExpensive = product.ListPrice &gt; 1000, Constant = 1 }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>It is translated to:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: blue;">CASE
        WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">)
        </span><span style="color: blue;">WHEN </span><span style="color: gray;">( NOT (</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">)))) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">)
    </span><span style="color: blue;">END AS </span><span style="color: black;">[C2]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]</span></pre>
<h2>Grouping</h2>
<p>The following is a simple GroupBy example, :</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">GroupBy()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">IGrouping</span><span style="color: black;">&lt;</span><span style="color: blue;">int</span><span style="color: black;">, </span><span style="color: blue;">string</span><span style="color: black;">&gt;&gt; groups = source.GroupBy(
        subcategory =&gt; subcategory.ProductCategoryID,
        subcategory =&gt; subcategory.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">groups.ForEach(group =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{group.Key}</span><span style="color: #a31515;">: </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, group)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Above GroupBy query is translated to LEFT OUTER JOIN instead of GROUP BY:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project2]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: blue;">CASE WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">IS NULL) </span><span style="color: blue;">THEN </span><span style="color: magenta;">CAST</span><span style="color: gray;">(NULL </span><span style="color: blue;">AS int</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: black;">1 </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM   </span><span style="color: gray;">(</span><span style="color: blue;">SELECT DISTINCT
            </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
            </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]
        </span><span style="color: gray;">LEFT OUTER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project2]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">ASC</span><span style="color: gray;">, </span><span style="color: black;">[Project2]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">ASC</span></pre>
<p>This is because above GroupBy returns hierarchical result (collection of groups, and each group is a collection of values), but SQL query can only result table of rows. So here is how it works:</p>
<ul>
<li>The translated SQL has to first query all the keys with a SELECT DISTINCT query</li>
<li>Then it has the keys to LEFT OUTER JOIN all the rows. The join result is a table of all group key and group value pairs (ProductCategoryID and Name pairs)</li>
<li>Then it sorts all the group key and group value pairs by the group keys, to make sure in the final result, the values appears group by group.</li>
<li>Eventually Entity Framework transforms the SQL result table into .NET hierarchical data structure, a IQueryable&lt;T&gt; collection of IGrouping&lt;T&gt; collections.</li>
</ul>
<p>To implement SQL GROUP BY query, just have the GroupBy query to return flattened result (collection of values). This can be done with a GroupBy overload accepting a resultSelector, or equivalently, an additional Select query:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">GroupByWithResultSelector()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">groups = source.GroupBy(
        subcategory =&gt; subcategory.ProductCategoryID,
        subcategory =&gt; subcategory.Name,
        (key, group) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ CategoryID = key, SubcategoryCount = group.Count() }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">groups.ForEach(group =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{group.CategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{group.SubcategoryCount}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">GroupByAndSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">groups = source
        .GroupBy(
            subcategory =&gt; subcategory.ProductCategoryID,
            subcategory =&gt; subcategory.Name)
        .Select(group =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ CategoryID = group.Key, SubcategoryCount = group.Count() }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">groups.ForEach(group =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{group.CategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{group.SubcategoryCount}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Notice aggregate query method Count is called to flattening the result. These 2 queries are semantically equivalent. They are both translated to identical GROUP BY query:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[K1] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[K1]</span><span style="color: gray;">,
        </span><span style="color: magenta;">COUNT</span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">GROUP BY </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]</span></pre>
<p>SelectMany can also flatten hierarchical result:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">GroupByAndSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; distinct = source
        .GroupBy(subcategory =&gt; subcategory.ProductCategoryID)
        .SelectMany(group =&gt; group); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(subcategory.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>This time no aggregate method is called, so above query cannot be translated to GROUP BY. It is translated to INNER JOIN:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
    </span><span style="color: blue;">FROM   </span><span style="color: gray;">(</span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]</span></pre>
<p>GroupBy’s keySelector can return anonymous type to support multiple keys:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">GroupByMultipleKeys()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">groups = source.GroupBy(
        product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ ProductSubcategoryID = product.ProductSubcategoryID, ListPrice = product.ListPrice },
        (key, group) =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            ProductSubcategoryID = key.ProductSubcategoryID,
            ListPrice = key.ListPrice,
            Count = group.Count()
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">groups.ForEach(group =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{group.ProductSubcategoryID}</span><span style="color: #a31515;">, </span><span style="color: black;">{group.ListPrice}</span><span style="color: #a31515;">: </span><span style="color: black;">{group.Count}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The key’s properties are translated to keys in GROUP BY clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[K2] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[K1] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C2]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[K1]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[K2]</span><span style="color: gray;">,
        </span><span style="color: magenta;">COUNT</span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">GROUP BY </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice]</span><span style="color: gray;">, </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]</span></pre>
<h2>Join</h2>
<h3>Inner join</h3>
<p>Besides above GroupBy, as discussed in the LINQ to Objects chapter, inner join can be done with Join and SelectMany. The following examples simply join the ProductSubcategory and ProductCategory entities with their ProductCategoryID properties:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories = outer.Join(
        inner,
        subcategory =&gt; subcategory.ProductCategoryID,
        category =&gt; category.ProductCategoryID,
        (subcategory, category) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = category.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span><span style="color: black;">

</span><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories = outer
        .SelectMany(
            subcategory =&gt; inner,
            (subcategory, category) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory, Category = category })
        .Where(crossJoinValue =&gt;
            crossJoinValue.Subcategory.ProductCategoryID == crossJoinValue.Category.ProductCategoryID)
        .Select(crossJoinValue =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = crossJoinValue.Subcategory.Name, Category = crossJoinValue.Category.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>And their query expression versions are similar:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories =
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on </span><span style="color: black;">subcategory.ProductCategoryID </span><span style="color: blue;">equals </span><span style="color: black;">category.ProductCategoryID
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = category.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span><span style="color: black;">

</span><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories =
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">where </span><span style="color: black;">subcategory.ProductCategoryID == category.ProductCategoryID
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = category.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}
</span></pre>
<p>Inner join can be translated from GroupJoin and Select too:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithGroupJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories = outer
        .GroupJoin(
            inner,
            subcategory =&gt; subcategory.ProductCategoryID,
            category =&gt; category.ProductCategoryID,
            (subcategory, categories) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory, Categories = categories })
        .SelectMany(
            subcategory =&gt; subcategory.Categories, </span><span style="color: green;">// LEFT OUTER JOIN if DefaultIfEmpty is called.
            </span><span style="color: black;">(subcategory, category) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory.Subcategory.Name, Category = category.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer
        .Select(subcategory =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Subcategory = subcategory,
            Categories = inner.Where(category =&gt; category.ProductCategoryID == subcategory.ProductCategoryID)
        })
        .SelectMany(
            subcategory =&gt; subcategory.Categories, </span><span style="color: green;">// LEFT OUTER JOIN if DefaultIfEmpty is called.
            </span><span style="color: black;">(subcategory, category) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory.Subcategory.Name, Category = category.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Here GroupJoin and Select returns hierarchical result, collection of collections, so SelectMany is called to flatten it to collection of values. Their query expression versions are:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithGroupJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories =
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on </span><span style="color: black;">subcategory.ProductCategoryID </span><span style="color: blue;">equals </span><span style="color: black;">category.ProductCategoryID </span><span style="color: blue;">into </span><span style="color: black;">categories
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">categories </span><span style="color: green;">// LEFT OUTER JOIN if DefaultIfEmpty is called.
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = category.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories =
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">select new
        </span><span style="color: black;">{
            Subcategory = subcategory,
            Categories = </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">inner
                         </span><span style="color: blue;">where </span><span style="color: black;">category.ProductCategoryID == subcategory.ProductCategoryID
                         </span><span style="color: blue;">select </span><span style="color: black;">category
        } </span><span style="color: blue;">into </span><span style="color: black;">subcategory
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">subcategory.Categories </span><span style="color: green;">// LEFT OUTER JOIN if DefaultIfEmpty is called.
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Subcategory = subcategory.Subcategory.Name, Category = category.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Here the ProductCategory and ProductSubCategory entities are associated, also inner join can be implemented by the navigation property:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithAssociation()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories = outer.Select(subcategory =&gt;
        </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = subcategory.ProductCategory.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>All the above queries are translated to the same INNER JOIN query:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]</span></pre>
<p>Apparently, navigation property is the easiest way for join query, as long as the entities are associated. The following example inner joins 3 entities, Product, ProductProductPhoto, ProductPhoto:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">MultipleInnerJoinsWithAssociations()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source.SelectMany(
        product =&gt; product.ProductProductPhotos,
        (product, productProductPhoto) =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Product = product.Name,
            Photo = productProductPhoto.ProductPhoto.LargePhotoFileName
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Product}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.Photo}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>It is translated to multiple INNER JOINs:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent3]</span><span style="color: gray;">.</span><span style="color: black;">[LargePhotoFileName] </span><span style="color: blue;">AS </span><span style="color: black;">[LargePhotoFileName]
    </span><span style="color: blue;">FROM   </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductProductPhoto] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductPhoto] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent3] </span><span style="color: blue;">ON </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductPhotoID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent3]</span><span style="color: gray;">.</span><span style="color: black;">[ProductPhotoID]</span></pre>
<p>If above query is implemented by Join with keys, or by SelectMany with keys, then multiple Join or SelectMany calls are needed.</p>
<p>Just like LINQ to Objects, to join with multiple keys, have the outerKeySelector and innerKeySelector return anonymous type. The following example joins the ProductSubcategory and ProductCategory entities with their ProductCategoryID properties, and their Name properties:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">InnerJoinWithMultipleKeys()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">subcategories = outer.Join(
        inner,
        subcategory =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = subcategory.ProductCategoryID, Name = subcategory.Name },
        category =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = category.ProductCategoryID, Name = category.Name },
        (subcategory, category) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Subcategory = subcategory.Name, Category = category.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">subcategories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The anonymous type’s properties is translated to keys of join:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">) AND (</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name]</span></pre>
<h3>Left outer join</h3>
<p>Left outer join can be done with GroupJoin and Select. The following examples joins ProductCategory and ProductSubcategory entities with their ProductCategoryID properties:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithGroupJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer.GroupJoin(
        inner,
        category =&gt; category.ProductCategoryID,
        subcategory =&gt; subcategory.ProductCategoryID,
        (category, subcategories) =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Category = category.Name,
            Subcategories = subcategories.Select(subcategory =&gt; subcategory.Name)
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, category.Subcategories)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer
        .Select(category =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Category = category.Name,
            Subcategories = inner
                .Where(subcategory =&gt; subcategory.ProductCategoryID == category.ProductCategoryID)
                .Select(subcategory =&gt; subcategory.Name)
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, category.Subcategories)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Their query expression versions are:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithGroupJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories =
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on </span><span style="color: black;">category.ProductCategoryID </span><span style="color: blue;">equals </span><span style="color: black;">subcategory.ProductCategoryID </span><span style="color: blue;">into </span><span style="color: black;">subcategories
        </span><span style="color: blue;">select new
        </span><span style="color: black;">{
            Category = category.Name,
            Subcategories = subcategories.Select(subcategory =&gt; subcategory.Name)
        }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, category.Subcategories)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories =
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">select new
        </span><span style="color: black;">{
            Category = category,
            Subcategories = </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">inner
                            </span><span style="color: blue;">where </span><span style="color: black;">subcategory.ProductCategoryID == category.ProductCategoryID
                            </span><span style="color: blue;">select </span><span style="color: black;">subcategory
        }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, category.Subcategories)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Above GroupJoin and Select returns hierarchical result, so they are both translated to the same pattern as the first GroupBy example above:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name1] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]</span><span style="color: gray;">,
        </span><span style="color: blue;">CASE WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">IS NULL) </span><span style="color: blue;">THEN </span><span style="color: magenta;">CAST</span><span style="color: gray;">(NULL </span><span style="color: blue;">AS int</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: black;">1 </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: gray;">LEFT OUTER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">ASC</span><span style="color: gray;">, </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">ASC</span></pre>
<p>To implement a simple left outer join query, just call SelectMany to flatten the hierarchical result:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithGroupJoinAndSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer
        .GroupJoin(
            inner,
            category =&gt; category.ProductCategoryID,
            subcategory =&gt; subcategory.ProductCategoryID,
            (category, subcategories) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category, Subcategories = subcategories })
        .SelectMany
            (category =&gt; category.Subcategories.DefaultIfEmpty(), </span><span style="color: green;">// INNER JOIN if DefaultIfEmpty is missing.
            </span><span style="color: black;">(category, subcategory) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category.Category.Name, Subcategory = subcategory.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithSelectAndSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer
        .Select(category =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Category = category,
            Subcategories = inner
                .Where(subcategory =&gt; subcategory.ProductCategoryID == category.ProductCategoryID)
        })
        .SelectMany(
            category =&gt; category.Subcategories.DefaultIfEmpty(), </span><span style="color: green;">// INNER JOIN if DefaultIfEmpty is missing.
            </span><span style="color: black;">(category, subcategory) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category.Category.Name, Subcategory = subcategory.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Notice DefaultIfEmpty must be called in SelectMany, otherwise the queries become inner join. And their query expression versions are:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithGroupJoinAndSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories =
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on </span><span style="color: black;">category.ProductCategoryID </span><span style="color: blue;">equals </span><span style="color: black;">subcategory.ProductCategoryID </span><span style="color: blue;">into </span><span style="color: black;">subcategories
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">subcategories.DefaultIfEmpty() </span><span style="color: green;">// INNER JOIN if DefaultIfEmpty is missing.
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Category = category.Name, Subcategory = subcategory.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithSelectAndSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories =
        </span><span style="color: blue;">from </span><span style="color: black;">category </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">select new
        </span><span style="color: black;">{
            Category = category,
            Subcategories = </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">inner
                            </span><span style="color: blue;">where </span><span style="color: black;">subcategory.ProductCategoryID == category.ProductCategoryID
                            </span><span style="color: blue;">select </span><span style="color: black;">subcategory
        } </span><span style="color: blue;">into </span><span style="color: black;">category
        </span><span style="color: blue;">from </span><span style="color: black;">subcategory </span><span style="color: blue;">in </span><span style="color: black;">category.Subcategories.DefaultIfEmpty() </span><span style="color: green;">// INNER JOIN if DefaultIfEmpty is missing.
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Category = category.Category.Name, Subcategory = subcategory.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Similar to inner join, left outer join can be done with entities association too:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">LeftOuterJoinWithAssociation()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = source.SelectMany(
        category =&gt; category.ProductSubcategories.DefaultIfEmpty(), </span><span style="color: green;">// INNER JOIN if DefaultIfEmpty is missing.
        </span><span style="color: black;">(category, subcategory) =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category.Name, Subcategory = subcategory.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.Category}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Subcategory}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Again, DefaultIfEmpty must be called in SelectMany, otherwise the query become inner join. The above flattened left outer join queries are translated to identical LEFT OUTER JOIN:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">LEFT OUTER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]</span></pre>
<h3>Cross join</h3>
<p>Just like LINQ to Objects, cross join can be done with SelectMany and Join. The following examples query the expensive products (list price greater than 2000) and cheap products (list price less than 100), and then cross join them to get all possible product bundles, where each bundle has one expensive product and one cheap product:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">CrossJoinWithSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products.Where(product =&gt; product.ListPrice &gt; 2000);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products.Where(product =&gt; product.ListPrice &lt; 100);
    </span><span style="color: blue;">var </span><span style="color: black;">bundles = outer.SelectMany(
        outerProduct =&gt; inner,
        (outerProduct, innerProduct) =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ Expensive = outerProduct.Name, Cheap = innerProduct.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">bundles.ForEach(bundle =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{bundle.Expensive}</span><span style="color: #a31515;">: </span><span style="color: black;">{bundle.Cheap}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">CrossJoinWithJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products.Where(product =&gt; product.ListPrice &gt; 2000);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products.Where(product =&gt; product.ListPrice &lt; 100);
    </span><span style="color: blue;">var </span><span style="color: black;">bundles = outer.Join(
        inner,
        product =&gt; </span><span style="color: blue;">true</span><span style="color: black;">,
        product =&gt; </span><span style="color: blue;">true</span><span style="color: black;">,
        (outerProduct, innerProduct) =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ Expensive = outerProduct.Name, Cheap = innerProduct.Name }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">bundles.ForEach(bundle =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{bundle.Expensive}</span><span style="color: #a31515;">: </span><span style="color: black;">{bundle.Cheap}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Their query expression versions are similar:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">CrossJoinWithSelectMany()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products.Where(product =&gt; product.ListPrice &gt; 2000);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products.Where(product =&gt; product.ListPrice &lt; 100);
    </span><span style="color: blue;">var </span><span style="color: black;">bundles =
        </span><span style="color: blue;">from </span><span style="color: black;">outerProduct </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">from </span><span style="color: black;">innerProduct </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: green;">// where true == true
        </span><span style="color: blue;">select new </span><span style="color: black;">{ Expensive = outerProduct.Name, Cheap = innerProduct.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">bundles.ForEach(bundle =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{bundle.Expensive}</span><span style="color: #a31515;">: </span><span style="color: black;">{bundle.Cheap}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">CrossJoinWithJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products.Where(product =&gt; product.ListPrice &gt; 2000);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products.Where(product =&gt; product.ListPrice &lt; 100);
    </span><span style="color: blue;">var </span><span style="color: black;">bundles =
        </span><span style="color: blue;">from </span><span style="color: black;">outerProduct </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">innerProduct </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on true equals true
        select new </span><span style="color: black;">{ Expensive = outerProduct.Name, Cheap = innerProduct.Name }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">bundles.ForEach(bundle =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{bundle.Expensive}</span><span style="color: #a31515;">: </span><span style="color: black;">{bundle.Cheap}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Above SelectMany is translated to CROSS JOIN, and Join is translated to INNER JOIN:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">CROSS JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
    </span><span style="color: blue;">WHERE </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">2000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) AND (</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&lt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">)))

</span><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">INNER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: black;">1 </span><span style="color: gray;">= </span><span style="color: black;">1
    </span><span style="color: blue;">WHERE </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">2000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) AND (</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&lt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">)))</span></pre>
<p>These 2 SQL queries are equivalent. They have the same query plan.</p>
<h3>Self join</h3>
<p>Entities can join with themselves. The following example joins the Products data source with Products data source with ListPrice, to query each product’s same price products.</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SelfJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = outer.GroupJoin(
        inner,
        product =&gt; product.ListPrice,
        product =&gt; product.ListPrice,
        (product, samePriceProducts) =&gt; </span><span style="color: blue;">new
        </span><span style="color: black;">{
            Name = product.Name,
            ListPrice = product.ListPrice,
            SamePriceProducts = samePriceProducts
                .Where(samePriceProduct =&gt; samePriceProduct.ProductID != product.ProductID)
                .Select(samePriceProduct =&gt; samePriceProduct.Name)
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name} </span><span style="color: #a31515;">(</span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">): </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, product.SamePriceProducts)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The the query expression version is:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SelfJoin()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; outer = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; inner = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products =
        </span><span style="color: blue;">from </span><span style="color: black;">outerProduct </span><span style="color: blue;">in </span><span style="color: black;">outer
        </span><span style="color: blue;">join </span><span style="color: black;">innerProduct </span><span style="color: blue;">in </span><span style="color: black;">inner
        </span><span style="color: blue;">on </span><span style="color: black;">outerProduct.ListPrice </span><span style="color: blue;">equals </span><span style="color: black;">innerProduct.ListPrice </span><span style="color: blue;">into </span><span style="color: black;">samePriceProducts
        </span><span style="color: blue;">select new
        </span><span style="color: black;">{
            Name = outerProduct.Name,
            ListPrice = outerProduct.ListPrice,
            SamePriceProducts = </span><span style="color: blue;">from </span><span style="color: black;">samePriceProduct </span><span style="color: blue;">in </span><span style="color: black;">samePriceProducts
                                </span><span style="color: blue;">where </span><span style="color: black;">samePriceProduct.ProductID != outerProduct.ProductID
                                </span><span style="color: blue;">select </span><span style="color: black;">samePriceProduct.Name
        }; </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name} </span><span style="color: #a31515;">(</span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">): </span><span style="color: black;">{</span><span style="color: blue;">string</span><span style="color: black;">.Join(</span><span style="color: #a31515;">", "</span><span style="color: black;">, product.SamePriceProducts)}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>They are translated to self join:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name1] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]</span><span style="color: gray;">,
        </span><span style="color: blue;">CASE WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: gray;">IS NULL) </span><span style="color: blue;">THEN </span><span style="color: magenta;">CAST</span><span style="color: gray;">(NULL </span><span style="color: blue;">AS int</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: black;">1 </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: gray;">LEFT OUTER JOIN </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2] </span><span style="color: blue;">ON </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice]</span><span style="color: gray;">) AND (</span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: gray;">&lt;&gt; </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID]</span><span style="color: gray;">)
    )  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductID] </span><span style="color: blue;">ASC</span><span style="color: gray;">, </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">ASC</span></pre>
<p>Again, the translated SQL contains this ORDER BY query, because GroupJoin returns hierarchical result</p>
<h2>Apply</h2>
<p>In SQL, APPLY matches each left table row with all rows in the right table. CROSS APPLY is similar to INNER JOIN, each row in left table will be in the result if there is any matching row in the right table; and OUTER APPLY is similar to OUTER JOIN, each row of the left table will be in the result no mater it has a match or not. For example:</p>
<pre class="code"><span style="color: blue;">SELECT </span><span style="color: black;">[Left]</span><span style="color: gray;">.</span><span style="color: black;">[Count]</span><span style="color: gray;">, </span><span style="color: black;">[Right]</span><span style="color: gray;">.</span><span style="color: black;">[Value] </span><span style="color: blue;">FROM
    </span><span style="color: gray;">(</span><span style="color: blue;">SELECT </span><span style="color: black;">[Count]
        </span><span style="color: blue;">FROM </span><span style="color: gray;">(</span><span style="color: blue;">VALUES </span><span style="color: gray;">(</span><span style="color: black;">0</span><span style="color: gray;">), (</span><span style="color: black;">1</span><span style="color: gray;">), (</span><span style="color: black;">2</span><span style="color: gray;">), (</span><span style="color: black;">3</span><span style="color: gray;">)) </span><span style="color: black;">[0 to 4]</span><span style="color: gray;">(</span><span style="color: black;">[Count]</span><span style="color: gray;">)) </span><span style="color: blue;">AS </span><span style="color: black;">[Left]
    </span><span style="color: gray;">CROSS APPLY
    (</span><span style="color: blue;">SELECT top </span><span style="color: gray;">(</span><span style="color: black;">[Count]</span><span style="color: gray;">) </span><span style="color: black;">[Value]
        </span><span style="color: blue;">FROM </span><span style="color: gray;">(</span><span style="color: blue;">VALUES </span><span style="color: gray;">(</span><span style="color: red;">N'a'</span><span style="color: gray;">), (</span><span style="color: red;">N'b'</span><span style="color: gray;">), (</span><span style="color: red;">N'c'</span><span style="color: gray;">), (</span><span style="color: red;">N'd'</span><span style="color: gray;">)) </span><span style="color: black;">[0 to 4]</span><span style="color: gray;">(</span><span style="color: black;">[Value]</span><span style="color: gray;">)) </span><span style="color: blue;">AS </span><span style="color: black;">[Right]</span><span style="color: gray;">;</span></pre>
<p>Here the left table is a table of numbers, the right table is a table of Unicode character strings. Each number will be matched to that number of strings, so the result is:</p>
<table>
<tbody>
<tr>
<td width="100">Count</td>
<td width="100">Value</td>
</tr>
<tr>
<td width="100">1</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">2</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">2</td>
<td width="100">b</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">b</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">c</td>
</tr>
</tbody>
</table>
<p>0 matches 0 strings, so 0 is not in the CROSS APPLY result. It will be in the OUTER APPLY result:</p>
<pre class="code"><span style="color: blue;">SELECT </span><span style="color: black;">[Left]</span><span style="color: gray;">.</span><span style="color: black;">[Count]</span><span style="color: gray;">, </span><span style="color: black;">[Right]</span><span style="color: gray;">.</span><span style="color: black;">[Value] </span><span style="color: blue;">FROM
    </span><span style="color: gray;">(</span><span style="color: blue;">SELECT </span><span style="color: black;">[Count]
        </span><span style="color: blue;">FROM </span><span style="color: gray;">(</span><span style="color: blue;">VALUES </span><span style="color: gray;">(</span><span style="color: black;">0</span><span style="color: gray;">), (</span><span style="color: black;">1</span><span style="color: gray;">), (</span><span style="color: black;">2</span><span style="color: gray;">), (</span><span style="color: black;">3</span><span style="color: gray;">)) </span><span style="color: black;">[0 to 4]</span><span style="color: gray;">(</span><span style="color: black;">[Count]</span><span style="color: gray;">)) </span><span style="color: blue;">AS </span><span style="color: black;">[Left]
    </span><span style="color: gray;">OUTER APPLY
    (</span><span style="color: blue;">SELECT top </span><span style="color: gray;">(</span><span style="color: black;">[Count]</span><span style="color: gray;">) </span><span style="color: black;">[Value]
        </span><span style="color: blue;">FROM </span><span style="color: gray;">(</span><span style="color: blue;">VALUES </span><span style="color: gray;">(</span><span style="color: red;">N'a'</span><span style="color: gray;">), (</span><span style="color: red;">N'b'</span><span style="color: gray;">), (</span><span style="color: red;">N'c'</span><span style="color: gray;">), (</span><span style="color: red;">N'd'</span><span style="color: gray;">)) </span><span style="color: black;">[0 to 4]</span><span style="color: gray;">(</span><span style="color: black;">[Value]</span><span style="color: gray;">)) </span><span style="color: blue;">AS </span><span style="color: black;">[Right]</span><span style="color: gray;">;</span></pre>
<table>
<tbody>
<tr>
<td width="100">Count</td>
<td width="100">Value</td>
</tr>
<tr>
<td width="100">0</td>
<td width="100">NULL</td>
</tr>
<tr>
<td width="100">1</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">2</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">2</td>
<td width="100">b</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">a</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">b</td>
</tr>
<tr>
<td width="100">3</td>
<td width="100">c</td>
</tr>
</tbody>
</table>
<h3>Cross apply</h3>
<p>In LINQ to Entities queries, SelectMany can flatten hierarchical data, for example, hierarchical result from GroupBy:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">CrossApplyWithGroupByAndTake()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = source
        .GroupBy(subcategory =&gt; subcategory.ProductCategoryID)
        .SelectMany(
            group =&gt; group.Take(1),
            (group, subcategory) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = group.Key, FirstSubcategory = subcategory }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.ProductCategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Here Take is called when flattening the hierarchical result. Logically, if a group is not empty, there will be 1 row for this group in the query result; and a group is empty, there will not be a row for this group in the query result. so above query is translated to CROSS APPLY:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID1]
    </span><span style="color: blue;">FROM   </span><span style="color: gray;">(</span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]
    </span><span style="color: gray;">CROSS APPLY  (</span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<p>As fore mentioned, GroupJoin and one-to-many association can produce hierarchical data, which then can be flattened by SelectMany:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">CrossApplyWithGroupJoinAndTake()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer
        .GroupJoin(
            inner,
            category =&gt; category.ProductCategoryID,
            subcategory =&gt; subcategory.ProductCategoryID,
            (category, subcategories) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category, Subcategories = subcategories })
        .SelectMany(
            category =&gt; category.Subcategories.Take(1),
            (category, subcategory) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category.Category, FirstSubcategory = subcategory }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">CrossApplyWithAssociationAndTake()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = source
        .Select(category =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category, Subcategories = category.ProductSubcategories })
        .SelectMany(
            category =&gt; category.Subcategories.Take(1),
            (category, subcategory) =&gt;
                </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category.Category, FirstSubcategory = subcategory }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>They are semantically equivalent. They will be translated to CROSS APPLY too, because of Take:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">CROSS APPLY  (</span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<h3>Outer apply</h3>
<p>FirstOrDefault accepts a IQueryable&lt;T&gt; data source and returns a single value, so it can be used to flatten hierarchical data too. again, take GroupBy as example:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OuterApplyWithGroupByAndFirstOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = source.GroupBy(
        subcategory =&gt; subcategory.ProductCategoryID,
        (key, group) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = key, FirstSubcategory = group.FirstOrDefault() }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.ProductCategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The different from Take is, no matter the group is empty or not, there is always 1 row for this group in the query result. So above query it translated to OUTER APPLY:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID1]
    </span><span style="color: blue;">FROM   </span><span style="color: gray;">(</span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]
    </span><span style="color: gray;">OUTER APPLY  (</span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<p>Similarly, when FirstOrDefault is called in GroupJoin or one-to-many association:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OuterApplyWithGroupJoinAndFirstOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; outer = AdventureWorks.ProductCategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; inner = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = outer.GroupJoin(
        inner,
        category =&gt; category.ProductCategoryID,
        subcategory =&gt; subcategory.ProductCategoryID,
        (category, subcategories) =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ Category = category, FirstSubcategory = subcategories.FirstOrDefault() }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">OuterApplyWithAssociationAndFirstOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductCategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductCategories;
    </span><span style="color: blue;">var </span><span style="color: black;">categories = source.Select(category =&gt; </span><span style="color: blue;">new
    </span><span style="color: black;">{
        Category = category,
        FirstSubcategory = category.ProductSubcategories.FirstOrDefault()
    }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">categories.ForEach(category =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{category.Category.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{category.FirstSubcategory?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>the translation is OUTER APPLY too:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID1]
    </span><span style="color: blue;">FROM  </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">OUTER APPLY  (</span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductSubcategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<h2>Concatenation</h2>
<p>The following example concatenates the cheap products’ names with the expensive products’ names:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Concat()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; first = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &lt; 100)
        .Select(product =&gt; product.Name);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; second = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &gt; 2000)
        .Select(product =&gt; product.Name);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; concat = first.Concat(second); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">concat.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Here Select is called before Concat. It is equivalent to call Select after Concat:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">ConcatWithSelect()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; first = AdventureWorks.Products.Where(product =&gt; product.ListPrice &lt; 100);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; second = AdventureWorks.Products.Where(product =&gt; product.ListPrice &gt; 2000);
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; concat = first
        .Concat(second)
        .Select(product =&gt; product.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">concat.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>They are both translate to identical UNION ALL query:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[UnionAll1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">(</span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&lt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))
    </span><span style="color: blue;">UNION </span><span style="color: gray;">ALL
        </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">2000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) </span><span style="color: blue;">AS </span><span style="color: black;">[UnionAll1]</span>&nbsp;</pre>
<h2>Set</h2>
<p>The following example queries the subcategories for the distinct ProductCategoryIDs:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Distinct()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">int</span><span style="color: black;">&gt; distinct = source
        .Select(subcategory =&gt; subcategory.ProductCategoryID)
        .Distinct(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(value =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(value)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Also, as fore mentioned, GroupBy can also query distinct group keys:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DistinctWithGroupBy()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">int</span><span style="color: black;">&gt; distinct = source.GroupBy(
        subcategory =&gt; subcategory.ProductCategoryID,
        (key, group) =&gt; key); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(value =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(value)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Here Distinct and GroupBy are translated to identical SELECT DISTINCT query:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]</span></pre>
<p>To query distinct multiple keys, use anonymous type:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DistinctMultipleKeys()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">distinct = source
        .Select(subcategory =&gt;
            </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = subcategory.ProductCategoryID, Name = subcategory.Name })
        .Distinct(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.ProductCategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">DistinctWithGroupByMultipleKeys()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: blue;">var </span><span style="color: black;">distinct = source.GroupBy(
        subcategory =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ ProductCategoryID = subcategory.ProductCategoryID, Name = subcategory.Name },
        (key, group) =&gt; key); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(
        </span><span style="color: #a31515;">$"</span><span style="color: black;">{subcategory.ProductCategoryID}</span><span style="color: #a31515;">: </span><span style="color: black;">{subcategory.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The anonymous type’s properties are translated into the SELECT DISTINCT clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
    </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]</span></pre>
<p>GroupBy can also be used for more complex scenarios, for example, query the complete entities with certain distinct properties. Please see above APPLY examples.</p>
<p>The following example queries subcategories’ Names, where they have distinct ProductCategoryIDs:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">DistinctWithGroupByAndFirstOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductSubcategory</span><span style="color: black;">&gt; source = AdventureWorks.ProductSubcategories;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; distinct = source.GroupBy(
        subcategory =&gt; subcategory.ProductCategoryID,
        (key, group) =&gt; group.Select(subcategory =&gt; subcategory.Name).FirstOrDefault()); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">distinct.ForEach(subcategory =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(subcategory)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>It is translated to:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: gray;">(</span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Distinct1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: gray;">= </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID]</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT DISTINCT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategoryID] </span><span style="color: blue;">AS </span><span style="color: black;">[ProductCategoryID]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Distinct1]</span></pre>
<p>The other set query methods, Intersect and Except:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Intersect()
{
    </span><span style="color: blue;">var </span><span style="color: black;">first = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &gt; 100)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice });
    </span><span style="color: blue;">var </span><span style="color: black;">second = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &lt; 2000)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice });
    </span><span style="color: blue;">var </span><span style="color: black;">intersect = first.Intersect(second); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">intersect.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">Except()
{
    </span><span style="color: blue;">var </span><span style="color: black;">first = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &gt; 100)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice });
    </span><span style="color: blue;">var </span><span style="color: black;">second = AdventureWorks.Products
        .Where(product =&gt; product.ListPrice &gt; 2000)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice });
    </span><span style="color: blue;">var </span><span style="color: black;">except = first.Except(second); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">except.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>are translated to INTERSECT and EXCEPT:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Intersect1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Intersect1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[C2]</span><span style="color: gray;">,
    </span><span style="color: black;">[Intersect1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[C3]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">(</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))
    </span><span style="color: blue;">INTERSECT
        SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&lt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">2000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) </span><span style="color: blue;">AS </span><span style="color: black;">[Intersect1]
    </span><span style="color: green;">
</span><span style="color: blue;">SELECT
    </span><span style="color: black;">[Except1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Except1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[C2]</span><span style="color: gray;">,
    </span><span style="color: black;">[Except1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[C3]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">(</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))
    </span><span style="color: blue;">EXCEPT
        SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent2]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent2]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">2000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))) </span><span style="color: blue;">AS </span><span style="color: black;">[Except1]</span></pre>
<h2>Partitioning</h2>
<p>Take cannot be used independently. OrderBy must be called before calling Skip. For example:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderByAndSkip()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; products = source
        .OrderBy(product =&gt; product.Name)
        .Skip(10)
        .Select(product =&gt; product.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Without OrderBy, Entity Framework throws NotSupportedException. The reason is, Skip is translated to OFFSET clause, and OFFSET requires ORDER BY:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">ASC
    </span><span style="color: black;">OFFSET 10 </span><span style="color: blue;">ROWS</span></pre>
<p>When Take is called without calling Skip:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Take()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; products = source
        .Take(10)
        .Select(product =&gt; product.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>it is translated to TOP:</p>
<pre class="code"><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">10</span><span style="color: gray;">)
    </span><span style="color: black;">[c]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[c]</span></pre>
<p>When Take is called with Skip:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderByAndSkipAndTake()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; products = source
        .OrderBy(product =&gt; product.Name)
        .Skip(20)
        .Take(10)
        .Select(product =&gt; product.Name); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>the translation becomes OFFSET-FETCH clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">ASC
    </span><span style="color: black;">OFFSET 20 </span><span style="color: blue;">ROWS FETCH NEXT </span><span style="color: black;">10 </span><span style="color: blue;">ROWS </span><span style="color: black;">ONLY</span></pre>
<p>This is extremely helpful for pagination.</p>
<h2>Ordering</h2>
<p>OrderBy/OrderByDescding are translated to ORDER BY clause with ASC/DESC. For example:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderBy()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source
        .OrderBy(product =&gt; product.ListPrice)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}

</span><span style="color: blue;">internal static void </span><span style="color: black;">OrderByDescending()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source
        .OrderByDescending(product =&gt; product.ListPrice)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>The translations are:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">ASC
</span><span style="color: green;">
</span><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">DESC</span></pre>
<p>To sort with multiple keys, call OrderBy/OrderByDescending and ThenBy/ThenByDescending:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderByAndThenBy()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source
        .OrderBy(product =&gt; product.ListPrice)
        .ThenBy(product =&gt; product.Name)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Similar to GroupBy/Join/GroupJoin, the ordering query methods’ keySelector can return anonymous type:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderByAnonymousType()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source
        .OrderBy(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ ListPrice = product.ListPrice, Name = product.Name })
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>These 2 queries are semantically equivalent. They are translated to identical ORDER BY query:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">ASC</span><span style="color: gray;">, </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">ASC</span></pre>
<p>If OrderBy/OrderByDescending are called multiple times:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">OrderByAndOrderBy()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">products = source
        .OrderBy(product =&gt; product.ListPrice)
        .OrderBy(product =&gt; product.Name)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>only the last call is translated:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Project1]
    </span><span style="color: blue;">ORDER BY </span><span style="color: black;">[Project1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">ASC</span></pre>
<h2>Conversion</h2>
<p>Cast can convert primitive types, for example, decimal (money) to string (nvarchar):</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Cast()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt; listPrices = source
        .Select(product =&gt; product.ListPrice)
        .Cast&lt;</span><span style="color: blue;">string</span><span style="color: black;">&gt;(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">listPrices.ForEach(listPrice =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(listPrice)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<p>Cast is translated to CAST:</p>
<pre class="code"><span style="color: blue;">SELECT
     </span><span style="color: magenta;">CAST</span><span style="color: gray;">( </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS nvarchar</span><span style="color: gray;">(</span><span style="color: magenta;">max</span><span style="color: gray;">)) </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]</span></pre>
<p>SQL function CAST only works for primitive types, so Cast query method cannot convert arbitrary data. The following example attempts to convert Product to UniversalProduct:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">CastEntity()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">&gt; universalProducts = source
        .Where(product =&gt; product.Name.StartsWith(</span><span style="color: #a31515;">"Road-750"</span><span style="color: black;">))
        .Cast&lt;</span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">&gt;(); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">universalProducts.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.GetType().Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
    // NotSupportedException: Unable to cast the type 'Dixin.Linq.EntityFramework.Product' to type 'Dixin.Linq.EntityFramework.UniversalProduct'. LINQ to Entities only supports casting EDM primitive or enumeration types.
</span><span style="color: black;">}</span></pre>
<p>Apparently, above conversion cannot be translated to a CAST expression, so Entity Framework throws a NotSupportedException.</p>
<p>The other conversion query method is AsQueryable. It has 2 overloads, a generic overload to convert IEnumerable&lt;T&gt; source to IQueryable&lt;T&gt;, and a non-generic overload to convert IEnumerable source to IQueryable. Also, remember Enumerable.AsEnumerable can convert more derived source (e.g., a IQueryable&lt;T&gt; source) to IEnumerable&lt;T&gt;. These AsQueryable/AsEnumerable methods look like the AsParallel/AsSequential methods, which convert between LINQ to Objects parallel/sequential queries. However, AsQueryable/AsEnumerable usually do not convert between remote LINQ to Entities query and local LINQ to Objects query. Here is the implementation of Enumerable.AsEnumerable, and Queryable.AsQueryable (the generic overload):</p>
<pre class="code"><span style="color: blue;">namespace </span><span style="color: black;">System.Linq
{
    </span><span style="color: blue;">using </span><span style="color: black;">System.Collections.Generic;

    </span><span style="color: blue;">public static class </span><span style="color: #2b91af;">Enumerable
    </span><span style="color: black;">{
        </span><span style="color: blue;">public static </span><span style="color: #2b91af;">IEnumerable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TSource</span><span style="color: black;">&gt; AsEnumerable&lt;</span><span style="color: #2b91af;">TSource</span><span style="color: black;">&gt;(</span><span style="color: blue;">this </span><span style="color: #2b91af;">IEnumerable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TSource</span><span style="color: black;">&gt; source) =&gt; source;
    }

    </span><span style="color: blue;">public static class </span><span style="color: #2b91af;">Queryable
    </span><span style="color: black;">{
        </span><span style="color: blue;">public static </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt; AsQueryable&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt;(</span><span style="color: blue;">this </span><span style="color: #2b91af;">IEnumerable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt; source) =&gt;
            source </span><span style="color: blue;">is </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt; ? (</span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt;)source : </span><span style="color: blue;">new </span><span style="color: #2b91af;">EnumerableQuery</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">TElement</span><span style="color: black;">&gt;(source);
    }
}</span></pre>
<p>AsQueryable accepts an IEnumerable&lt;T&gt; source. If the input source is indeed an IQueryable&lt;T&gt; source, then return the input source; if not, wrap the input source into an EnumerablleQuery&lt;T&gt; object, and return it. EnumerablleQuery&lt;T&gt; is a special implementation of IQueryable&lt;T&gt;. When pulling values from EnumerableQuery&lt;T&gt; source, System.Linq.EnumerableRewriter.Visit is called to translate the query to local LINQ to Objects query, then execute the query locally. As a result, AsEnumerable can convert a remote LINQ to Entities query to local LINQ to Objects query, but AsQueryable cannot convert a local LINQ to Objects query to a remote LINQ to Entities query (and logically, a local .NET data source cannot be converted to a remote SQL data source). For example:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">AsEnumerableAsQueryable()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source1 = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">query1 = source1 </span><span style="color: green;">// DbSet&lt;T&gt; object, derives from DbQuery&lt;T&gt;.
        </span><span style="color: black;">.Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }) </span><span style="color: green;">// Return DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.AsEnumerable() </span><span style="color: green;">// Do nothing, directly return the input DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.AsQueryable() </span><span style="color: green;">// Do nothing, directly return the input DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.Where(product =&gt; product.ListPrice &gt; 0); </span><span style="color: green;">// Continue LINQ to Entities query.
    </span><span style="color: black;">query1.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">));

    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source2 = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">query2 = source2 </span><span style="color: green;">// DbSet&lt;T&gt; object, derives from DbQuery&lt;T&gt;.
        </span><span style="color: black;">.Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice }) </span><span style="color: green;">// Return DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.AsEnumerable() </span><span style="color: green;">// Do nothing, directly return the input DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.Select(product =&gt; product) </span><span style="color: green;">// Enumerable.Select, returns a generator wrapping the input DbQuery&lt;T&gt; object.
        </span><span style="color: black;">.AsQueryable() </span><span style="color: green;">// Return an EnumerableQuery&lt;T&gt; object wrapping the input generator.
        </span><span style="color: black;">.Where(product =&gt; product.ListPrice &gt; 0); </span><span style="color: green;">// No longer LINQ to Entities query on DbSet&lt;T&gt; or DbQuery&lt;T&gt;.
    </span><span style="color: black;">query2.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">));
}</span></pre>
<p>In the first query:</p>
<ul>
<li>Select is called on DbSet&lt;T&gt; source,&nbsp; it returns a DbQuery&lt;T&gt;, and it will be translated to SQL query.</li>
<li>AsEnumerable returns the input source directly, which is actually an DbQuery&lt;T&gt; source.</li>
<li>Then, AsQueryable is called. since the input DbQuery&lt;T&gt; source is IQueryable&lt;T&gt;, it directly returns the input source again.</li>
<li>So after calling AsEnumerable and AsQueryable, nothing happens. Where is still LINQ to Entities query on DbQuery&lt;T&gt;, it will be translated to WHERE clause.</li>
</ul>
<p>So it is translated as if AsEnumerable call and AsQueryable call do not exist:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))</span></pre>
<p>In the second query:</p>
<ul>
<li>The first Select will be translated to SQL query.</li>
<li>The second Select is called after AsEnumerable, so it is Enumerable.Select instead of Queryable.Select. As discussed in the LINQ to Objects chapter, Enumerable.Select returns a generator, which wraps the input source.</li>
<li>Then AsQueryable is called. Since the input generator is not IQueryable&lt;T&gt;, it returns an EnumerableQuery&lt;T&gt;, which wraps he generator.</li>
<li>Where is called on EnumerbaleQuery&lt;T&gt; source, it will be translated to LINQ to Objects query.</li>
</ul>
<p>The translated SQL does not have the WHERE clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]</span></pre>
<p>AsEnumerable can be useful for LINQ to Entities for some special cases. For example, LINQ to Entities’ Select query method does not support mapping to existing entity type:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SelectEntities()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; products = source
        .Where(product =&gt; product </span><span style="color: blue;">is </span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">)
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">()
        {
            ProductID = product.ProductID,
            Name = product.Name,
            ListPrice = product.ListPrice,
            ProductSubcategoryID = product.ProductSubcategoryID
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{product.ProductID}</span><span style="color: #a31515;">: </span><span style="color: black;">{product.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
    // NotSupportedException: The entity or complex type 'Dixin.Linq.EntityFramework.UniversalProduct' cannot be constructed in a LINQ to Entities query.
</span><span style="color: black;">}</span></pre>
<p>Executing above query throws a NotSupportedException. This is by design, because this kind of mapping causes difficulties for Entity Framework. For example, by default DbContext maintains the mapping between remote rows and query result entities, and constructing entities on the fly prevents doing so. Here, one solution is to construct the UniversalProduct entities with local LINQ to Objects query:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SelectEntityObjects()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: #2b91af;">IEnumerable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; products = source
        .Where(product =&gt; product </span><span style="color: blue;">is </span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">) </span><span style="color: green;">// Return IQueryable&lt;Product&gt;. LINQ to Entities.
        </span><span style="color: black;">.AsEnumerable() </span><span style="color: green;">// Return IEnumerable&lt;(int, string)&gt;. LINQ to Objects from here.
        </span><span style="color: black;">.Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: #2b91af;">UniversalProduct</span><span style="color: black;">()
        {
            ProductID = product.ProductID,
            Name = product.Name,
            ListPrice = product.ListPrice,
            ProductSubcategoryID = product.ProductSubcategoryID
        }); </span><span style="color: green;">// Define query.
    </span><span style="color: black;">products.ForEach(product =&gt; </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(product.Name)); </span><span style="color: green;">// Execute query.
</span><span style="color: black;">}</span></pre>
<h1>Return a single value</h1>
<p>Query methods in this category takes an IQueryable&lt;T&gt; input source and returns a single value. As demonstrated above, they can be used with the other query methods to flatten hierarchical data, like aggregation query method with GroupBy are translated to SQL aggregation function with GROUP BY, etc. When they are called at the end of a LINQ to Entities query, they returns some value with immediate execution, which is similar behavior to LINQ to Objects.</p>
<h2>Element</h2>
<p>First/FirstOrDefault execute the LINQ to Entities queries immediately for the first value/first or default value. The following example queries the first product’s Name:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">First()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">string </span><span style="color: black;">first = source
        .Select(product =&gt; product.Name)
        .First(); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(first);
}</span></pre>
<p>It is translated to TOP (1):</p>
<pre class="code"><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
    </span><span style="color: black;">[c]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]
    </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[c]</span></pre>
<p>First/FirstOrDefault can also accept a predicate expression tree. The following example queries the first or default product with ListPrice greater than 5000:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">FirstOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">firstOrDefault = source
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice })
        .FirstOrDefault(product =&gt; product.ListPrice &gt; 5000); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{firstOrDefault?.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">);
}</span></pre>
<p>The predicate is translated to WHERE clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">5000 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))
    )  </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<p>As discussed in LINQ to Objects, Single/SingleOrDefault look similar to, but the semantics is more strict:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Single()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">single = source
        .Select(product =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ Name = product.Name, ListPrice = product.ListPrice })
        .Single(product =&gt; product.ListPrice &lt; 50); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{single.Name}</span><span style="color: #a31515;">"</span><span style="color: black;">);
}</span></pre>
<p>To ensure the query result does not have more than 1 row, Single/SingleOrDefault are translated to TOP (2):</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">2</span><span style="color: gray;">)
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[Name] </span><span style="color: blue;">AS </span><span style="color: black;">[Name]</span><span style="color: gray;">,
        </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&lt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">50 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))</span></pre>
<p>Single/SingleOrDefault can also accept predicate:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">SingleOrDefault()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">var </span><span style="color: black;">singleOrDefault = source
        .GroupBy(
            subcategory =&gt; subcategory.ListPrice,
            (key, groups) =&gt; </span><span style="color: blue;">new </span><span style="color: black;">{ ListPrice = key, Count = groups.Count() })
        .SingleOrDefault(group =&gt; group.Count &gt; 10); </span><span style="color: green;">// Define query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(</span><span style="color: #a31515;">$"</span><span style="color: black;">{singleOrDefault?.ListPrice}</span><span style="color: #a31515;">"</span><span style="color: black;">);
}</span></pre>
<p>It is translated to WHERE as well:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[C2] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
    </span><span style="color: black;">[Limit1]</span><span style="color: gray;">.</span><span style="color: black;">[C1] </span><span style="color: blue;">AS </span><span style="color: black;">[C2]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT TOP </span><span style="color: gray;">(</span><span style="color: black;">2</span><span style="color: gray;">)
        </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]</span><span style="color: gray;">,
        </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[K1] </span><span style="color: blue;">AS </span><span style="color: black;">[ListPrice]</span><span style="color: gray;">,
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C2]
        </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
            </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: blue;">AS </span><span style="color: black;">[K1]</span><span style="color: gray;">,
            </span><span style="color: magenta;">COUNT</span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
            </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
            </span><span style="color: blue;">GROUP BY </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice]
        </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: gray;">&gt; </span><span style="color: black;">10
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[Limit1]</span></pre>
<h2>Aggregation</h2>
<p>Count/LongCount are translated to SQL aggregate functions COUNT/COUNT_BIG, and the provided predicate is translated to WHERE clause. The following examples query the System.Int32 count of categories, and the System.Int64 count of the products with ListPrice greater than 0:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Count()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">int </span><span style="color: black;">count = source.Count(); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(count);
}

</span><span style="color: blue;">internal static void </span><span style="color: black;">LongCount()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">long </span><span style="color: black;">longCount = source.LongCount(product =&gt; product.ListPrice &gt; 0); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(longCount);
}</span></pre>
<p>They are translated to:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: magenta;">COUNT</span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductCategory] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]
</span><span style="color: green;">
</span><span style="color: blue;">SELECT
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: magenta;">COUNT_BIG</span><span style="color: gray;">(</span><span style="color: black;">1</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice] </span><span style="color: gray;">&gt; </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">))
    )  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]</span></pre>
<p>Max/Min are translated to MAX/MIN functions.&nbsp; If a selector is provided, the selector is translated to argument of MAX/MIN. The following examples query the latest ModifiedDate of photos, and the lowest ListPrice of products:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Max()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">ProductPhoto</span><span style="color: black;">&gt; source = AdventureWorks.ProductPhotos;
    </span><span style="color: #2b91af;">DateTime </span><span style="color: black;">max = source.Select(photo =&gt; photo.ModifiedDate).Max(); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(max);
}

</span><span style="color: blue;">internal static void </span><span style="color: black;">Min()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">decimal </span><span style="color: black;">min = source.Min(product =&gt; product.ListPrice); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(min);
}</span></pre>
<p>Their translations are in the same pattern:</p>
<pre class="code"><span style="color: blue;">SELECT
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: magenta;">MAX</span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ModifiedDate]</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[ProductPhoto] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]
</span><span style="color: green;">
</span><span style="color: blue;">SELECT
    </span><span style="color: black;">[GroupBy1]</span><span style="color: gray;">.</span><span style="color: black;">[A1] </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM </span><span style="color: gray;">( </span><span style="color: blue;">SELECT
        </span><span style="color: magenta;">MIN</span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice]</span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[A1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)  </span><span style="color: blue;">AS </span><span style="color: black;">[GroupBy1]</span></pre>
<p>Min/Max cannot evaluate for any type, because SQL MAX/MIN functions only accept numeric, character string, uniqueidentifier, and datetime arguments.</p>
<p>For other scenarios, like query some properties</p>
<h2>Quantifier</h2>
<p>Any is translated to EXISTS operator, and the LINQ to Entities query before Any is translated to subquery of EXISTS. The following example simply query whether any product exists:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Any()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">bool </span><span style="color: black;">anyUniversal = source.Any(); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(anyUniversal);
}</span></pre>
<p>It is translated to:</p>
<pre class="code"><span style="color: blue;">SELECT
    CASE WHEN </span><span style="color: gray;">( EXISTS (</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
    </span><span style="color: gray;">)) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]</span></pre>
<p>Contains can be implemented by Any equivalently, so Contains is translated to EXISTS too. The following example queries whether any product’s ListPrice is 100:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">Contains()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: green;">// Only primitive types or enumeration types are supported.
    </span><span style="color: blue;">bool </span><span style="color: black;">contains = source.Select(product =&gt; product.ListPrice).Contains(100); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(contains);
}</span></pre>
<p>It is equivalent to the following Any query:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">AnyWithPredicate()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">bool </span><span style="color: black;">anyUniversal = source.Any(product =&gt; product.ListPrice == 100); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(anyUniversal);
}</span></pre>
<p>They are translated to identical EXISTS query, and the predicate for Any is translated to WHERE clause:</p>
<pre class="code"><span style="color: blue;">SELECT
    CASE WHEN </span><span style="color: gray;">( EXISTS (</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">100 </span><span style="color: blue;">as decimal</span><span style="color: gray;">(</span><span style="color: black;">18</span><span style="color: gray;">)) = </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ListPrice]
    </span><span style="color: gray;">)) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]</span></pre>
<p>All can be implemented by Any equivalently too. The following example queries whether all products’ ListPrices are not 100:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">AllNot()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">bool </span><span style="color: black;">allNot = source.All(product =&gt; product.ProductSubcategoryID != </span><span style="color: blue;">null</span><span style="color: black;">); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(allNot);
}</span></pre>
<p>It is equivalent to query whether not any product’s ListPrice is 100:</p>
<pre class="code"><span style="color: blue;">internal static void </span><span style="color: black;">NotAny()
{
    </span><span style="color: #2b91af;">IQueryable</span><span style="color: black;">&lt;</span><span style="color: #2b91af;">Product</span><span style="color: black;">&gt; source = AdventureWorks.Products;
    </span><span style="color: blue;">bool </span><span style="color: black;">notAny = !source.Any(product =&gt; !(product.ProductSubcategoryID != </span><span style="color: blue;">null</span><span style="color: black;">)); </span><span style="color: green;">// Execute query.
    </span><span style="color: #2b91af;">Trace</span><span style="color: black;">.WriteLine(notAny);
}</span></pre>
<p>So above All query is translated to NOT EXISTS, and in the subquery’s WHERE clause, != null is translated to opposite condition IS NULL:</p>
<pre class="code"><span style="color: blue;">SELECT
    CASE WHEN </span><span style="color: gray;">( NOT EXISTS (</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: gray;">IS NULL)
            OR (</span><span style="color: blue;">CASE </span><span style="color: green;">-- OR and the succeeding condition is redundant.
                    </span><span style="color: blue;">WHEN </span><span style="color: gray;">(</span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: gray;">IS NOT NULL) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">)
                    </span><span style="color: blue;">ELSE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">)
                </span><span style="color: blue;">END </span><span style="color: gray;">IS NULL)
    )) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]
</span><span style="color: green;">
</span><span style="color: blue;">SELECT
    CASE WHEN </span><span style="color: gray;">( EXISTS (</span><span style="color: blue;">SELECT
        </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">[C1]
        </span><span style="color: blue;">FROM </span><span style="color: black;">[Production]</span><span style="color: gray;">.</span><span style="color: black;">[Product] </span><span style="color: blue;">AS </span><span style="color: black;">[Extent1]
        </span><span style="color: blue;">WHERE </span><span style="color: black;">[Extent1]</span><span style="color: gray;">.</span><span style="color: black;">[ProductSubcategoryID] </span><span style="color: gray;">IS NULL
    )) </span><span style="color: blue;">THEN </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">1 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">ELSE </span><span style="color: magenta;">cast</span><span style="color: gray;">(</span><span style="color: black;">0 </span><span style="color: blue;">as bit</span><span style="color: gray;">) </span><span style="color: blue;">END AS </span><span style="color: black;">[C1]
    </span><span style="color: blue;">FROM  </span><span style="color: gray;">( </span><span style="color: blue;">SELECT </span><span style="color: black;">1 </span><span style="color: blue;">AS </span><span style="color: black;">X </span><span style="color: gray;">) </span><span style="color: blue;">AS </span><span style="color: black;">[SingleRowTable1]</span></pre>
<p>Their translation are not identical, but in the same pattern. In the ALL translation, the WHERE clause’s OR operator and the succeeding condition is redundant. Also the Any translation is EXISTS, the “not” any is done by the .NET ! operator outside the LINQ to Entities query, so it is not translated.</p>


</div>
</body>
</html>
